@{
    ViewData["Title"] = "Manage Car Brands";
}

<div class="container-fluid mt-4">
    <h2>Car Brands Management</h2>

    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" id="txtSearch" class="form-control" placeholder="Search brands..." />
        </div>
        <div class="col-md-8 d-flex justify-content-end">
            <button id="btnAddNew" class="btn btn-success">Add New Brand</button>
        </div>
    </div>

    <table class="table table-bordered table-striped" id="tblCarBrands">
        <thead>
            <tr>
                <th>Name</th>
                <th>Country</th>
                <th>Website</th>
                <th>Luxury</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal for Add/Edit Brand -->
<div class="modal fade" id="brandModal" tabindex="-1" aria-labelledby="brandModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="brandForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="brandModalLabel">Add/Edit Brand</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="brandId" />

                <div class="mb-3">
                    <label for="brandName" class="form-label">Brand Name</label>
                    <input type="text" id="brandName" class="form-control" maxlength="60" required />
                </div>

                <div class="mb-3">
                    <label for="brandCountry" class="form-label">Country of Origin</label>
                    <input type="text" id="brandCountry" class="form-control" maxlength="50" />
                </div>

                <div class="mb-3">
                    <label for="brandWebsite" class="form-label">Brand Website</label>
                    <input type="url" id="brandWebsite" class="form-control" maxlength="200" />
                </div>

                <div class="form-check mb-3">
                    <input type="checkbox" id="isLuxuryBrand" class="form-check-input" />
                    <label for="isLuxuryBrand" class="form-check-label">Is Luxury Brand</label>
                </div>

                <div class="form-check mb-3">
                    <input type="checkbox" id="isActiveBrand" class="form-check-input" checked />
                    <label for="isActiveBrand" class="form-check-label">Is Active Brand</label>
                </div>

                <div class="mb-3">
                    <label for="brandNotes" class="form-label">Notes</label>
                    <textarea id="brandNotes" class="form-control" rows="3" maxlength="500"></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save Brand</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- jQuery and Bootstrap JS (use your versions) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(function () {
        var brandModal = new bootstrap.Modal($('#brandModal')[0]);

        function loadBrands(search = '') {
            $.ajax({
                url: '/CarBrands/GetAll',
                type: 'GET',
                data: { search: search },
                success: function (data) {
                    var tbody = $('#tblCarBrands tbody').empty();
                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan="6" class="text-center">No brands found</td></tr>');
                        return;
                    }
                    $.each(data, function (i, brand) {
                        tbody.append(`<tr>
                            <td>${brand.brandName}</td>
                            <td>${brand.brandCountryOfOrigin || ''}</td>
                            <td><a href="${brand.brandWebsite}" target="_blank">${brand.brandWebsite}</a></td>
                            <td>${brand.isLuxuryBrand ? '✅' : '❌'}</td>
                            <td>${brand.isActiveBrand ? '✅' : '❌'}</td>
                            <td>
                                <button class="btn btn-sm btn-warning btn-edit" data-id="${brand.brandId}">Edit</button>
                                <button class="btn btn-sm btn-danger btn-delete" data-id="${brand.brandId}">Delete</button>
                            </td>
                        </tr>`);
                    });
                },
                error: function () {
                    alert('Failed to load brands.');
                }
            });
        }

        loadBrands();

        $('#txtSearch').on('input', function () {
            loadBrands($(this).val());
        });

        $('#btnAddNew').click(function () {
            clearForm();
            $('#brandModalLabel').text('Add New Brand');
            brandModal.show();
        });

        function clearForm() {
            $('#brandId').val('');
            $('#brandName').val('');
            $('#brandCountry').val('');
            $('#brandWebsite').val('');
            $('#isLuxuryBrand').prop('checked', false);
            $('#isActiveBrand').prop('checked', true);
            $('#brandNotes').val('');
        }

        $('#brandForm').submit(function (e) {
            e.preventDefault();

            var brandData = {
                brandId: $('#brandId').val(),
                brandName: $('#brandName').val().trim(),
                brandCountryOfOrigin: $('#brandCountry').val().trim(),
                brandWebsite: $('#brandWebsite').val().trim(),
                isLuxuryBrand: $('#isLuxuryBrand').prop('checked'),
                isActiveBrand: $('#isActiveBrand').prop('checked'),
                brandNotes: $('#brandNotes').val().trim()
            };

            var url = brandData.brandId ? '/CarBrands/Update' : '/CarBrands/Create';

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(brandData),
                success: function (res) {
                    alert(res.message || 'Operation successful');
                    brandModal.hide();
                    loadBrands();
                },
                error: function (xhr) {
                    alert('Error: ' + xhr.responseText);
                }
            });
        });

        $('#tblCarBrands').on('click', '.btn-edit', function () {
            var id = $(this).data('id');
            $.ajax({
                url: '/CarBrands/GetById?id=' + id,
                type: 'GET',
                success: function (brand) {
                    $('#brandId').val(brand.brandId);
                    $('#brandName').val(brand.brandName);
                    $('#brandCountry').val(brand.brandCountryOfOrigin);
                    $('#brandWebsite').val(brand.brandWebsite);
                    $('#isLuxuryBrand').prop('checked', brand.isLuxuryBrand);
                    $('#isActiveBrand').prop('checked', brand.isActiveBrand);
                    $('#brandNotes').val(brand.brandNotes);
                    $('#brandModalLabel').text('Edit Brand');
                    brandModal.show();
                },
                error: function () {
                    alert('Failed to load brand data.');
                }
            });
        });

        $('#tblCarBrands').on('click', '.btn-delete', function () {
            if (!confirm('Are you sure you want to delete this brand?')) return;

            var id = $(this).data('id');
            $.ajax({
                url: '/CarBrands/Delete?id=' + id,
                type: 'DELETE',
                success: function (res) {
                    alert(res.message || 'Deleted successfully');
                    loadBrands();
                },
                error: function (xhr) {
                    alert('Delete failed: ' + xhr.responseText);
                }
            });
        });
    });
</script>
