<!DOCTYPE html>
<html>
<head>
    <title>Car Details - Loading...</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="fullscreen-mode">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span class="ms-3">Loading car details...</span>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div hidden id="mainContent" style="display: none;">
        <!-- Full Screen Header with Car Title -->
        <div class="fullscreen-header bg-dark text-white py-2 px-3 position-fixed w-100" style="top: 0; z-index: 1000;">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0" id="carTitleHeader">Loading...</h5>
                <div class="d-flex align-items-center">
                    <span id="priceHeaderSmall" class="me-3">₹0</span>
                    <button class="btn btn-outline-light btn-sm" onclick="window.close()" title="Close Window">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content with top margin for fixed header -->
        <div class="container-fluid px-0" style="margin-top: 60px;">
            <!-- Image Carousel Section - Full Width -->
            <div class="row g-0">
                <div class="col-lg-8">
                    <!-- Car Images Carousel -->
                    <div class="fullscreen-carousel">
                        <div id="carImageCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner" id="carouselImages">
                                <!-- Images will be loaded via JavaScript -->
                            </div>
                            <div id="carouselControls" style="display: none;">
                                <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                            </div>
                            <!-- Image Thumbnails -->
                            <div id="carouselThumbnails" class="carousel-thumbnails p-2" style="display: none;">
                                <div class="row g-1" id="thumbnailRow">
                                    <!-- Thumbnails will be loaded via JavaScript -->
                                </div>
                            </div>
                            <!-- Image indicators -->
                            <div class="carousel-indicators" id="carouselIndicators" style="display: none;">
                                <!-- Indicators will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - Price & Contact -->
                <div class="col-lg-4 bg-light border-start">
                    <div class="p-3 h-100">
                        <!-- Price Section -->
                        <div class="text-center mb-4 p-3 bg-white rounded shadow-sm">
                            <div id="priceHeader">
                                <!-- Price will be loaded via JavaScript -->
                            </div>
                        </div>

                        <!-- Contact Buttons -->
                        <div class="d-grid gap-2 mb-4" id="contactButtons">
                            <!-- Contact buttons will be loaded via JavaScript -->
                        </div>

                        <!-- Quick EMI Calculator -->
                        <div class="emi-section mb-4 p-3 bg-white rounded shadow-sm">
                            <h6 class="mb-3 text-primary">
                                <i class="fas fa-calculator me-2"></i>EMI Calculator
                            </h6>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="loanAmount" placeholder="Loan Amount">
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="loanTenure">
                                        <option value="36">3 Years</option>
                                        <option value="48">4 Years</option>
                                        <option value="60" selected>5 Years</option>
                                        <option value="72">6 Years</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100" onclick="calculateQuickEMI()">
                                Calculate EMI
                            </button>
                            <div id="quickEMIResult" class="mt-2 text-center" style="display: none;">
                                <div class="alert alert-success p-2 mb-0">
                                    <strong>EMI: ₹<span id="quickEMIAmount">0</span>/month</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Seller Information -->
                        <div class="seller-info mb-4 p-3 bg-white rounded shadow-sm">
                            <h6 class="mb-3 text-primary">
                                <i class="fas fa-user me-2"></i>Seller Information
                            </h6>
                            <div id="sellerInfoContent">
                                <!-- Seller info will be loaded via JavaScript -->
                            </div>
                        </div>

                        <!-- Car Stats -->
                        <div class="car-stats p-3 bg-white rounded shadow-sm" id="carStats" style="display: none;">
                            <h6 class="mb-3 text-primary">
                                <i class="fas fa-chart-bar me-2"></i>Popularity
                            </h6>
                            <div id="carStatsContent">
                                <!-- Car stats will be loaded via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Information Section -->
            <div class="row g-0">
                <div class="col-12">
                    <div class="p-4 bg-white">
                        <!-- Car Title and Badges -->
                        <div class="mb-4">
                            <h2 class="mb-3" id="carTitle">Loading...</h2>
                            <div id="carBadges">
                                <!-- Badges will be loaded via JavaScript -->
                            </div>
                        </div>

                        <!-- Information Tabs -->
                        <ul class="nav nav-tabs" id="carDetailTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                    <i class="fas fa-info-circle me-2"></i>Basic Information
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs" type="button" role="tab">
                                    <i class="fas fa-cog me-2"></i>Specifications
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab">
                                    <i class="fas fa-list me-2"></i>Features
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab">
                                    <i class="fas fa-file-alt me-2"></i>Documentation
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content mt-4" id="carDetailTabContent">
                            <!-- Basic Information Tab -->
                            <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="text-primary mb-3">Basic Details</h5>
                                        <table class="table table-borderless" id="basicInfoTable">
                                            <!-- Basic info will be loaded via JavaScript -->
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="text-primary mb-3">Usage & Condition</h5>
                                        <table class="table table-borderless" id="usageInfoTable">
                                            <!-- Usage info will be loaded via JavaScript -->
                                        </table>
                                    </div>
                                </div>

                                <!-- Condition Ratings -->
                                <div id="conditionRatings" class="mt-4" style="display: none;">
                                    <h5 class="text-primary mb-3">Condition Ratings</h5>
                                    <div class="row" id="ratingsRow">
                                        <!-- Ratings will be loaded via JavaScript -->
                                    </div>
                                </div>

                                <!-- Additional Information -->
                                <div id="additionalInfoCard" class="mt-4" style="display: none;">
                                    <h5 class="text-primary mb-3">Additional Information</h5>
                                    <div id="additionalInfoContent">
                                        <!-- Additional info will be loaded via JavaScript -->
                                    </div>
                                </div>
                            </div>

                            <!-- Technical Specifications Tab -->
                            <div class="tab-pane fade" id="specs" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="text-primary mb-3">Engine & Performance</h5>
                                        <table class="table table-borderless" id="engineSpecsTable">
                                            <!-- Engine specs will be loaded via JavaScript -->
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="text-primary mb-3">Dimensions & Comfort</h5>
                                        <table class="table table-borderless" id="dimensionsTable">
                                            <!-- Dimensions will be loaded via JavaScript -->
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Features Tab -->
                            <div class="tab-pane fade" id="features" role="tabpanel">
                                <div id="featuresContent">
                                    <!-- Features will be loaded via JavaScript -->
                                </div>
                            </div>

                            <!-- Documentation Tab -->
                            <div class="tab-pane fade" id="docs" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 class="text-primary mb-3">Documentation</h5>
                                        <table class="table table-borderless" id="documentationTable">
                                            <!-- Documentation will be loaded via JavaScript -->
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5 class="text-primary mb-3">Service History</h5>
                                        <div id="serviceHistoryContent">
                                            <!-- Service history will be loaded via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Similar Cars Section -->
            <div class="row g-0 mt-4" id="similarCarsSection" style="display: none;">
                <div class="col-12">
                    <div class="p-4 bg-light">
                        <h5 class="mb-4 text-primary">
                            <i class="fas fa-cars me-2"></i>Similar Cars You Might Like
                        </h5>
                        <div class="row" id="similarCarsContainer">
                            <!-- Similar cars will be loaded via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inquiry Modal -->
    <div class="modal fade" id="inquiryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contact Seller</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inquiryForm">
                        <input type="hidden" id="inquiryListingId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerName" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="customerName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerPhone" class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" id="customerPhone" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="customerEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="inquiryType" class="form-label">Inquiry Type</label>
                                    <select class="form-select" id="inquiryType">
                                        <option value="General Inquiry">General Inquiry</option>
                                        <option value="Price Negotiation">Price Negotiation</option>
                                        <option value="Test Drive">Test Drive Request</option>
                                        <option value="Inspection">Inspection Request</option>
                                        <option value="Finance">Finance Options</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="message" class="form-label">Message</label>
                            <textarea class="form-control" id="message" rows="3" placeholder="I am interested in this car..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="budgetRange" class="form-label">Budget Range</label>
                                    <select class="form-select" id="budgetRange">
                                        <option value="">Select Budget Range</option>
                                        <option value="Under 2 Lakh">Under ₹2 Lakh</option>
                                        <option value="2-5 Lakh">₹2-5 Lakh</option>
                                        <option value="5-10 Lakh">₹5-10 Lakh</option>
                                        <option value="10-20 Lakh">₹10-20 Lakh</option>
                                        <option value="Above 20 Lakh">Above ₹20 Lakh</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3 d-flex align-items-end">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="financeRequired">
                                        <label class="form-check-label" for="financeRequired">
                                            I need finance assistance
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitInquiry()">Send Inquiry</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let carData = null;
        let currentListingId = null;

        // Hide any sidebar elements on page load
        function hideAllSidebars() {
            // Hide common sidebar classes and IDs
            const sidebarSelectors = [
                '.sidebar', '.nav-sidebar', '.left-sidebar', '.menu-sidebar',
                '.navigation-menu', '.offcanvas', '.offcanvas-start',
                '.navbar-collapse', '.collapse', '#sidebar', '#nav-sidebar',
                '#leftSidebar', '#navigationMenu', '[class*="sidebar"]',
                '[class*="nav-"]', '[class*="menu-"]'
            ];

            sidebarSelectors.forEach(selector => {
                try {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.style.width = '0';
                        el.style.height = '0';
                        el.style.overflow = 'hidden';
                        el.style.position = 'absolute';
                        el.style.left = '-9999px';
                    });
                } catch (e) {
                    // Ignore errors for invalid selectors
                }
            });

            // Ensure main content takes full width
            const mainContent = document.body;
            if (mainContent) {
                mainContent.style.marginLeft = '0';
                mainContent.style.paddingLeft = '0';
                mainContent.style.width = '100vw';
                mainContent.style.maxWidth = '100vw';
            }

            // Remove any Bootstrap classes that might show sidebars
            document.body.classList.remove('sidebar-open', 'nav-open', 'menu-open');
            document.documentElement.classList.remove('sidebar-open', 'nav-open', 'menu-open');
        }

        $(document).ready(function() {
            console.log('Document ready - starting fullscreen mode');

            // Hide all sidebars immediately
            hideAllSidebars();

            // Hide sidebars again after a short delay to catch dynamically loaded elements
            setTimeout(hideAllSidebars, 100);
            setTimeout(hideAllSidebars, 500);

            // Get listing ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentListingId = urlParams.get('id') || getListingIdFromPath();

            if (currentListingId) {
                loadCarDetails(currentListingId);
            } else {
                showError('Car ID not found in URL. Please check the URL format.');
            }
        });

        function getListingIdFromPath() {
            const pathSegments = window.location.pathname.split('/');
            const lastSegment = pathSegments[pathSegments.length - 1];
            if (lastSegment && !isNaN(lastSegment)) {
                return lastSegment;
            }
            const secondLast = pathSegments[pathSegments.length - 2];
            if (secondLast && !isNaN(secondLast)) {
                return secondLast;
            }
            return null;
        }

        function loadCarDetails(listingId) {
            $.ajax({
                url: `/SearchView/GetCarDetail/${listingId}`,
                type: 'GET',
                dataType: 'json',
                timeout: 10000,
                success: function(response) {
                    if (response && response.success && response.data) {
                        carData = response.data;
                        populateCarDetails(carData);
                        recordCarView(listingId);
                    } else {
                        showError(response?.message || 'Failed to load car details - Invalid response structure');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'Failed to load car details. ';
                    if (xhr.status === 0) {
                        errorMessage += 'Network error - check if server is running.';
                    } else if (xhr.status === 404) {
                        errorMessage += 'Endpoint not found (404). Check controller method exists.';
                    } else if (xhr.status === 500) {
                        errorMessage += 'Server error (500). Check server logs.';
                    } else {
                        errorMessage += `Error ${xhr.status}: ${error}`;
                    }
                    showError(errorMessage);
                }
            });
        }

        function populateCarDetails(car) {
            try {
                // Update page title and headers
                document.title = car.title || 'Car Details';
                $('#carTitle').text(car.title || 'Loading...');
                $('#carTitleHeader').text(car.title || 'Loading...');

                // Populate all sections
                populateBadges(car);
                populateImages(car);
                populateBasicInfo(car);
                populateUsageInfo(car);
                populateConditionRatings(car);
                populateTechnicalSpecs(car);
                populateFeatures(car);
                populateAdditionalInfo(car);
                populateDocumentationAndService(car);
                populatePriceAndContact(car);
                populateSellerInfo(car);
                populateCarStats(car);
                loadSimilarCars(car.listingId);
                setupEventHandlers(car);

                // Hide loading spinner and show content
                $('#loadingSpinner').hide();
                $('#mainContent').show();
                $('#mainContent').css('display', 'block');

                // Ensure no sidebars are visible after content loads
                setTimeout(hideAllSidebars, 200);

            } catch (error) {
                console.error('Error in populateCarDetails:', error);
                showError('Error displaying car details: ' + error.message);
            }
        }

        function populateBadges(car) {
            let badges = '';
            if (car.isVerified) badges += '<span class="badge bg-success me-2">✓ Verified</span>';
            if (car.isFeatured) badges += '<span class="badge bg-warning me-2">★ Featured</span>';
            if (car.isUrgentSale) badges += '<span class="badge bg-danger me-2">🔥 Urgent Sale</span>';
            if (!car.hasAccidentHistory) badges += '<span class="badge bg-info me-2">No Accident</span>';
            else badges += '<span class="badge bg-warning me-2">⚠️ Accident History</span>';

            if (car.badges && car.badges.length > 0) {
                car.badges.forEach(badge => {
                    if (!badges.includes(badge)) {
                        badges += `<span class="badge bg-secondary me-2">${badge}</span>`;
                    }
                });
            }
            $('#carBadges').html(badges);
        }

        function populateImages(car) {
            let carouselHtml = '';
            let thumbnailHtml = '';
            let indicatorHtml = '';
            let allImages = [];

            if (car.primaryImage) {
                allImages.push({
                    url: car.primaryImage,
                    alt: `${car.title || 'Car'} - Primary Image`
                });
            }

            if (car.additionalImages) {
                if (Array.isArray(car.additionalImages)) {
                    car.additionalImages.forEach((image, index) => {
                        const imageUrl = typeof image === 'string' ? image : (image.url || image.imageUrl);
                        if (imageUrl) {
                            allImages.push({
                                url: imageUrl,
                                alt: `${car.title || 'Car'} - Additional Image ${index + 1}`
                            });
                        }
                    });
                } else if (typeof car.additionalImages === 'string') {
                    try {
                        const parsedImages = JSON.parse(car.additionalImages);
                        if (Array.isArray(parsedImages)) {
                            parsedImages.forEach((image, index) => {
                                const imageUrl = typeof image === 'string' ? image : (image.url || image.imageUrl);
                                if (imageUrl) {
                                    allImages.push({
                                        url: imageUrl,
                                        alt: `${car.title || 'Car'} - Additional Image ${index + 1}`
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.log('Additional images is not valid JSON:', car.additionalImages);
                    }
                }
            }

            if (allImages.length === 0) {
                allImages.push({
                    url: 'https://via.placeholder.com/800x600/f8f9fa/6c757d?text=No+Image+Available',
                    alt: 'No Image Available'
                });
            }

            allImages.forEach((image, index) => {
                const activeClass = index === 0 ? 'active' : '';
                carouselHtml += `
                    <div class="carousel-item ${activeClass}">
                        <img src="${image.url}" class="d-block w-100 car-detail-image" alt="${image.alt}"
                             onerror="this.src='https://via.placeholder.com/800x600/f8f9fa/6c757d?text=Image+Not+Found'">
                    </div>`;

                indicatorHtml += `
                    <button type="button" data-bs-target="#carImageCarousel" data-bs-slide-to="${index}"
                            class="${activeClass}" aria-current="${index === 0 ? 'true' : 'false'}"
                            aria-label="Slide ${index + 1}"></button>`;

                if (allImages.length > 1) {
                    const thumbActiveClass = index === 0 ? 'active' : '';
                    thumbnailHtml += `
                        <div class="col-2">
                            <img src="${image.url}" class="img-thumbnail carousel-thumb ${thumbActiveClass}"
                                 data-bs-target="#carImageCarousel" data-bs-slide-to="${index}"
                                 alt="Thumbnail ${index + 1}"
                                 onerror="this.src='https://via.placeholder.com/150x100/f8f9fa/6c757d?text=No+Image'">
                        </div>`;
                }
            });

            $('#carouselImages').html(carouselHtml);

            if (allImages.length > 1) {
                $('#carouselControls').show();
                $('#carouselThumbnails').show();
                $('#carouselIndicators').show();
                $('#thumbnailRow').html(thumbnailHtml);
                $('#carouselIndicators').html(indicatorHtml);

                $('.carousel-thumb').off('click').on('click', function() {
                    $('.carousel-thumb').removeClass('active');
                    $(this).addClass('active');
                });
            } else {
                $('#carouselControls').hide();
                $('#carouselThumbnails').hide();
                $('#carouselIndicators').hide();
            }

            const carouselElement = document.querySelector('#carImageCarousel');
            if (carouselElement && window.bootstrap) {
                const carousel = new bootstrap.Carousel(carouselElement);
            }
        }

        function populateBasicInfo(car) {
            let html = `
                <tr><td><i class="fas fa-car text-muted me-2"></i>Brand</td><td><strong>${car.brandName || 'N/A'}</strong></td></tr>
                <tr><td><i class="fas fa-tag text-muted me-2"></i>Model</td><td><strong>${car.modelName || 'N/A'}</strong></td></tr>`;
            if (car.variantName) html += `<tr><td><i class="fas fa-cog text-muted me-2"></i>Variant</td><td><strong>${car.variantName}</strong></td></tr>`;
            html += `
                <tr><td><i class="fas fa-calendar text-muted me-2"></i>Year</td><td><strong>${car.year || 'N/A'}</strong></td></tr>
                <tr><td><i class="fas fa-gas-pump text-muted me-2"></i>Fuel Type</td><td><strong>${car.fuelType || 'N/A'}</strong></td></tr>
                <tr><td><i class="fas fa-cogs text-muted me-2"></i>Transmission</td><td><strong>${car.transmission || 'N/A'}</strong></td></tr>`;
            $('#basicInfoTable').html(html);
        }

        function populateUsageInfo(car) {
            let html = `<tr><td><i class="fas fa-tachometer-alt text-muted me-2"></i>Kilometers</td><td><strong>${(car.kilometersOnOdometer || 0).toLocaleString()} km</strong></td></tr>`;
            if (car.totalPreviousOwners) {
                const ownerText = car.totalPreviousOwners === 1 ? '1st Owner' : `${car.totalPreviousOwners}th Owner`;
                html += `<tr><td><i class="fas fa-user text-muted me-2"></i>Owners</td><td><strong>${ownerText}</strong></td></tr>`;
            }
            html += `<tr><td><i class="fas fa-map-marker-alt text-muted me-2"></i>Location</td><td><strong>${car.cityName || 'N/A'}, ${car.stateName || 'N/A'}</strong></td></tr>`;
            if (car.areaOrLocality) html += `<tr><td><i class="fas fa-location-dot text-muted me-2"></i>Area</td><td><strong>${car.areaOrLocality}</strong></td></tr>`;
            if (car.overallCondition) html += `<tr><td><i class="fas fa-star text-muted me-2"></i>Condition</td><td><strong>${car.overallCondition}</strong></td></tr>`;
            if (car.color) html += `<tr><td><i class="fas fa-palette text-muted me-2"></i>Color</td><td><strong>${car.color}</strong></td></tr>`;
            $('#usageInfoTable').html(html);
        }

        function populateConditionRatings(car) {
            let html = '';
            let hasRatings = false;

            if (car.exteriorRating) {
                hasRatings = true;
                html += `<div class="col-md-4 mb-3"><div class="text-center p-3 bg-light rounded"><i class="fas fa-car fa-2x text-primary mb-2"></i><h6>Exterior</h6><div class="rating-stars">${generateStarRating(car.exteriorRating)}</div><small class="text-muted">${car.exteriorRating}/5</small></div></div>`;
            }
            if (car.interiorRating) {
                hasRatings = true;
                html += `<div class="col-md-4 mb-3"><div class="text-center p-3 bg-light rounded"><i class="fas fa-couch fa-2x text-primary mb-2"></i><h6>Interior</h6><div class="rating-stars">${generateStarRating(car.interiorRating)}</div><small class="text-muted">${car.interiorRating}/5</small></div></div>`;
            }
            if (car.engineRating) {
                hasRatings = true;
                html += `<div class="col-md-4 mb-3"><div class="text-center p-3 bg-light rounded"><i class="fas fa-cog fa-2x text-primary mb-2"></i><h6>Engine</h6><div class="rating-stars">${generateStarRating(car.engineRating)}</div><small class="text-muted">${car.engineRating}/5</small></div></div>`;
            }

            if (hasRatings) {
                $('#ratingsRow').html(html);
                $('#conditionRatings').show();
            }
        }

        function generateStarRating(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                const starClass = i <= rating ? 'text-warning' : 'text-muted';
                stars += `<i class="fas fa-star ${starClass}"></i>`;
            }
            return stars;
        }

        function populateTechnicalSpecs(car) {
            let engineHtml = `
                <tr><td>Fuel Type</td><td><strong>${car.fuelType || 'N/A'}</strong></td></tr>
                <tr><td>Transmission</td><td><strong>${car.transmission || 'N/A'}</strong></td></tr>`;
            if (car.engineCC) engineHtml += `<tr><td>Engine Capacity</td><td><strong>${car.engineCC} cc</strong></td></tr>`;
            if (car.engineBHP) engineHtml += `<tr><td>Power</td><td><strong>${car.engineBHP} BHP</strong></td></tr>`;
            if (car.mileage) engineHtml += `<tr><td>Mileage</td><td><strong>${car.mileage} kmpl</strong></td></tr>`;
            $('#engineSpecsTable').html(engineHtml);

            let dimensionsHtml = `
                <tr><td>Manufacturing Year</td><td><strong>${car.year || 'N/A'}</strong></td></tr>
                <tr><td>Registration Year</td><td><strong>${car.year || 'N/A'}</strong></td></tr>`;
            if (car.seatingCapacity) dimensionsHtml += `<tr><td>Seating Capacity</td><td><strong>${car.seatingCapacity} Persons</strong></td></tr>`;
            if (car.bootSpace) dimensionsHtml += `<tr><td>Boot Space</td><td><strong>${car.bootSpace} Litres</strong></td></tr>`;
            if (car.color) dimensionsHtml += `<tr><td>Color</td><td><strong>${car.color}</strong></td></tr>`;
            $('#dimensionsTable').html(dimensionsHtml);
        }

        function populateFeatures(car) {
            if (car.featureGroups && car.featureGroups.length > 0) {
                let html = '';
                car.featureGroups.forEach(group => {
                    html += `<div class="mb-4"><h6 class="text-primary mb-3">${group.categoryName}</h6><div class="row">`;
                    group.features.forEach(feature => {
                        const iconClass = feature.isAvailable ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-muted';
                        const textClass = feature.isAvailable ? '' : 'text-muted';
                        const conditionText = feature.condition ? ` (${feature.condition})` : '';
                        html += `<div class="col-md-6 col-lg-4 mb-2"><div class="d-flex align-items-center"><i class="${iconClass} me-2"></i><span class="${textClass}">${feature.featureName}</span>${conditionText ? `<small class="text-muted ms-1">${conditionText}</small>` : ''}</div></div>`;
                    });
                    html += `</div></div>`;
                });
                $('#featuresContent').html(html);
            }
        }

        function populateAdditionalInfo(car) {
            let html = '';
            let hasContent = false;

            if (car.detailedDescription) {
                hasContent = true;
                html += `<div class="mb-3"><h6 class="text-primary">Description</h6><p>${car.detailedDescription}</p></div>`;
            }
            if (car.specialHighlights) {
                hasContent = true;
                html += `<div class="mb-3"><h6 class="text-primary">Special Highlights</h6><p>${car.specialHighlights}</p></div>`;
            }
            if (car.sellingReason) {
                hasContent = true;
                html += `<div class="mb-3"><h6 class="text-primary">Reason for Selling</h6><p>${car.sellingReason}</p></div>`;
            }
            if (car.knownIssues) {
                hasContent = true;
                html += `<div class="mb-3"><h6 class="text-warning">Known Issues</h6><p class="text-muted">${car.knownIssues}</p></div>`;
            }

            if (hasContent) {
                $('#additionalInfoContent').html(html);
                $('#additionalInfoCard').show();
            }
        }

        function populateDocumentationAndService(car) {
            let docHtml = '';
            if (car.registrationNumber) docHtml += `<tr><td>Registration No.</td><td><strong>${car.registrationNumber}</strong></td></tr>`;
            if (car.rtoCode) docHtml += `<tr><td>RTO Code</td><td><strong>${car.rtoCode}</strong></td></tr>`;
            if (car.insuranceType) docHtml += `<tr><td>Insurance</td><td><strong>${car.insuranceType}</strong></td></tr>`;
            if (car.insuranceExpiry) {
                const insuranceDate = new Date(car.insuranceExpiry);
                docHtml += `<tr><td>Insurance Expiry</td><td><strong>${insuranceDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}</strong></td></tr>`;
            }
            if (car.pucExpiry) {
                const pucDate = new Date(car.pucExpiry);
                docHtml += `<tr><td>PUC Expiry</td><td><strong>${pucDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}</strong></td></tr>`;
            }
            $('#documentationTable').html(docHtml);

            // Service History
            let serviceHtml = '';
            const serviceIcon = car.hasCompleteServiceHistory ? 'fas fa-check-circle text-success' : 'fas fa-exclamation-triangle text-warning';
            const serviceText = car.hasCompleteServiceHistory ? 'Complete Service History Available' : 'Partial Service History';
            serviceHtml += `<div class="d-flex align-items-center mb-2"><i class="${serviceIcon} me-2"></i><span>${serviceText}</span></div>`;

            const authorizedIcon = car.servicedAtAuthorized ? 'fas fa-check-circle text-success' : 'fas fa-times-circle text-muted';
            const authorizedText = car.servicedAtAuthorized ? 'Serviced at Authorized Center' : 'Not Serviced at Authorized Center';
            serviceHtml += `<div class="d-flex align-items-center mb-2"><i class="${authorizedIcon} me-2"></i><span>${authorizedText}</span></div>`;

            if (car.lastServiceDate) {
                const serviceDate = new Date(car.lastServiceDate);
                serviceHtml += `<p class="mb-1"><strong>Last Service:</strong> ${serviceDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'})}</p>`;
            }
            if (car.lastServiceKM) serviceHtml += `<p class="mb-1"><strong>Last Service KM:</strong> ${car.lastServiceKM.toLocaleString()} km</p>`;
            $('#serviceHistoryContent').html(serviceHtml);
        }

        function populatePriceAndContact(car) {
            let priceHtml = `<h3 class="text-primary mb-0">₹${(car.sellingPrice || 0).toLocaleString()}</h3>`;
            if (car.originalPrice && car.originalPrice > car.sellingPrice) {
                const savings = car.originalPrice - car.sellingPrice;
                priceHtml += `<small class="text-muted text-decoration-line-through">₹${car.originalPrice.toLocaleString()}</small><span class="badge bg-success ms-2">₹${savings.toLocaleString()} Saved</span>`;
            }
            if (car.isPriceNegotiable) priceHtml += `<div class="mt-1"><small class="text-success">✓ Price Negotiable</small></div>`;
            if (car.priceLabel) priceHtml += `<div class="mt-1"><span class="badge bg-info">${car.priceLabel}</span></div>`;

            $('#priceHeader').html(priceHtml);
            $('#priceHeaderSmall').text(`₹${(car.sellingPrice || 0).toLocaleString()}`);
            $('#loanAmount').val(car.sellingPrice || 0);

            let contactHtml = `<button class="btn btn-primary btn-lg" onclick="showInquiryModal(${car.listingId}, '${car.title}')"><i class="fas fa-phone me-2"></i>Contact Seller</button>`;
            if (car.availableForTestDrive) contactHtml += `<button class="btn btn-outline-primary" onclick="requestTestDrive(${car.listingId})"><i class="fas fa-car me-2"></i>Book Test Drive</button>`;
            if (car.availableForInspection) contactHtml += `<button class="btn btn-outline-secondary" onclick="requestInspection(${car.listingId})"><i class="fas fa-search me-2"></i>Schedule Inspection</button>`;
            contactHtml += `<button class="btn btn-outline-info" onclick="shareCarDetail(${car.listingId})"><i class="fas fa-share me-2"></i>Share This Car</button>`;
            $('#contactButtons').html(contactHtml);
        }

        function populateSellerInfo(car) {
            let html = `<div class="d-flex align-items-center mb-2"><i class="fas fa-user text-muted me-2"></i><span><strong>${car.sellerName || 'N/A'}</strong></span><span class="badge bg-secondary ms-2">${car.sellerType || 'Individual'}</span></div>`;
            if (car.sellerPhone) html += `<div class="d-flex align-items-center mb-2"><i class="fas fa-phone text-muted me-2"></i><span>${car.sellerPhone}</span></div>`;
            if (car.preferredContactMethod) html += `<div class="d-flex align-items-center mb-2"><i class="fas fa-clock text-muted me-2"></i><small class="text-muted">Preferred: ${car.preferredContactMethod}</small></div>`;
            if (car.contactHours) html += `<div class="d-flex align-items-center"><i class="fas fa-calendar text-muted me-2"></i><small class="text-muted">Available: ${car.contactHours}</small></div>`;
            $('#sellerInfoContent').html(html);
        }

        function populateCarStats(car) {
            if (car.totalViews || car.totalInquiries) {
                let html = '';
                if (car.totalViews) html += `<div class="d-flex justify-content-between mb-1"><small class="text-muted">Total Views</small><small><strong>${car.totalViews.toLocaleString()}</strong></small></div>`;
                if (car.totalInquiries) html += `<div class="d-flex justify-content-between"><small class="text-muted">Inquiries</small><small><strong>${car.totalInquiries}</strong></small></div>`;
                $('#carStatsContent').html(html);
                $('#carStats').show();
            }
        }

        function loadSimilarCars(listingId) {
            $.ajax({
                url: `/SearchView/GetSimilarCars`,
                type: 'GET',
                data: { listingId: listingId, count: 6 },
                success: function(response) {
                    if (response && response.success && response.data && response.data.length > 0) {
                        populateSimilarCars(response.data);
                    }
                },
                error: function() {
                    console.log('Failed to load similar cars');
                }
            });
        }

        function populateSimilarCars(cars) {
            let html = '';
            cars.forEach(car => {
                const imageUrl = car.primaryImage || 'https://via.placeholder.com/200x150/f8f9fa/6c757d?text=No+Image';
                html += `
                    <div class="col-md-4 col-lg-2 mb-3">
                        <div class="card car-card-small h-100">
                            <img src="${imageUrl}" class="card-img-top" alt="${car.title}" style="height: 120px; object-fit: cover;">
                            <div class="card-body p-2">
                                <h6 class="card-title text-truncate small">${car.title}</h6>
                                <p class="card-text text-primary fw-bold mb-1 small">₹${(car.sellingPrice || 0).toLocaleString()}</p>
                                <small class="text-muted d-block">${car.year} • ${(car.kilometersOnOdometer || 0).toLocaleString()} km</small>
                                <small class="text-muted">${car.cityName}</small>
                            </div>
                            <div class="card-footer bg-transparent p-2">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="viewCarDetail(${car.listingId})">View</button>
                            </div>
                        </div>
                    </div>`;
            });
            $('#similarCarsContainer').html(html);
            $('#similarCarsSection').show();
        }

        function setupEventHandlers(car) {
            // Event handlers for various buttons
        }

        function showError(message) {
            $('#loadingSpinner').hide();
            $('#mainContent').html(`
                <div class="container mt-5">
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">Error!</h4>
                        <p>${message}</p>
                        <hr>
                        <p class="mb-0">
                            <button class="btn btn-primary" onclick="window.close()">Close Window</button>
                        </p>
                    </div>
                </div>`);
            $('#mainContent').show();
        }

        function recordCarView(listingId) {
            $.post('/SearchView/RecordCarView', { listingId: listingId }).fail(() => console.log('Failed to record car view'));
        }

        function calculateQuickEMI() {
            const amount = parseFloat($('#loanAmount').val());
            const months = parseInt($('#loanTenure').val());
            if (!amount || !months) {
                alert('Please enter loan amount and select tenure');
                return;
            }
            $.get('/SearchView/CalculateEMI', { amount: amount, rate: 8.5, months: months })
            .done(response => {
                if (response.success) {
                    $('#quickEMIAmount').text(response.emi.toLocaleString());
                    $('#quickEMIResult').show();
                } else {
                    alert('EMI calculation failed');
                }
            })
            .fail(() => alert('EMI calculation failed'));
        }

        function showInquiryModal(listingId, carTitle) {
            $('#inquiryListingId').val(listingId);
            $('#inquiryModal .modal-title').text(`Contact Seller - ${carTitle}`);
            $('#inquiryModal').modal('show');
        }

        function submitInquiry() {
            const inquiryData = {
                listingId: parseInt($('#inquiryListingId').val()),
                customerName: $('#customerName').val(),
                customerPhone: $('#customerPhone').val(),
                customerEmail: $('#customerEmail').val(),
                inquiryType: $('#inquiryType').val(),
                message: $('#message').val(),
                budgetRange: $('#budgetRange').val(),
                financeRequired: $('#financeRequired').is(':checked')
            };

            if (!inquiryData.customerName || !inquiryData.customerPhone) {
                alert('Please fill in all required fields.');
                return;
            }

            $.ajax({
                url: '/SearchView/SubmitInquiry',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(inquiryData),
                success: function(response) {
                    if (response.success) {
                        $('#inquiryModal').modal('hide');
                        $('#inquiryForm')[0].reset();
                        alert('Your inquiry has been submitted successfully! The seller will contact you soon.');
                    } else {
                        alert('Failed to submit inquiry: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while submitting your inquiry. Please try again.');
                }
            });
        }

        function requestTestDrive(listingId) {
            $('#inquiryType').val('Test Drive');
            $('#message').val('I would like to schedule a test drive for this car. Please let me know your available times.');
            showInquiryModal(listingId, carData.title);
        }

        function requestInspection(listingId) {
            $('#inquiryType').val('Inspection');
            $('#message').val('I would like to schedule an inspection for this car. Please let me know your available times.');
            showInquiryModal(listingId, carData.title);
        }

        function shareCarDetail(listingId) {
            const url = window.location.href;
            const title = carData ? carData.title : 'Car Details';
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: `Check out this car: ${title}`,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => alert('Link copied to clipboard!'));
            }
        }

        function viewCarDetail(listingId) {
            window.location.href = `/SearchView/CarDetail?id=${listingId}`;
        }
    </script>

    <style>
        /* Full Screen Mode Styles - Hide all navigation and sidebars */
        .fullscreen-mode {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* Hide any existing sidebar/navigation elements */
        .sidebar,
        .nav-sidebar,
        .left-sidebar,
        .menu-sidebar,
        .navigation-menu,
        [class*="sidebar"],
        [class*="nav-"],
        [class*="menu-"] {
            display: none !important;
        }

        /* Ensure body takes full width */
        body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100vw !important;
            max-width: 100vw !important;
        }

        /* Remove any left margins that might be caused by hidden sidebars */
        .container-fluid,
        .main-content,
        #mainContent {
            margin-left: 0 !important;
            padding-left: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Override any framework styles that might show sidebars */
        .layout-wrapper,
        .page-wrapper,
        .content-wrapper {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }

        /* Hide Bootstrap offcanvas or collapse sidebars */
        .offcanvas,
        .offcanvas-start,
        .offcanvas-end,
        .collapse.show {
            display: none !important;
        }

        /* Hide any toggle buttons for sidebars */
        .navbar-toggler,
        .sidebar-toggle,
        .menu-toggle,
        [data-bs-toggle="offcanvas"],
        [data-toggle="sidebar"] {
            display: none !important;
        }

        /* Additional aggressive sidebar hiding */
        * {
            /* Remove any left margins from all elements */
        }

        body * {
            /* Ensure no element has left margin that could indicate sidebar space */
        }

        /* Force full width layout */
        html, body {
            width: 100vw !important;
            max-width: 100vw !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Hide specific framework sidebars by common class patterns */
        .sidenav,
        .side-nav,
        .sidebar-wrapper,
        .sidebar-container,
        .main-sidebar,
        .control-sidebar,
        .navbar-nav,
        .nav-pills,
        .nav-tabs.vertical,
        .accordion.sidebar,
        .list-group.sidebar {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }

        .fullscreen-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .fullscreen-carousel {
            height: 60vh;
            min-height: 400px;
        }

        .car-detail-image {
            height: 60vh;
            min-height: 400px;
            object-fit: cover;
            width: 100%;
        }

        .carousel-thumb {
            height: 50px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

            .carousel-thumb:hover,
            .carousel-thumb.active {
                border-color: #007bff;
                transform: scale(1.05);
            }

        .rating-stars .fa-star {
            font-size: 14px;
        }

        .emi-section {
            border: 1px solid #e3f2fd;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        /* Tab styling */
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
        }

            .nav-tabs .nav-link.active {
                color: #007bff;
                border-bottom: 3px solid #007bff;
                background: transparent;
            }

            .nav-tabs .nav-link:hover {
                border-color: transparent;
                color: #007bff;
            }

        /* Table styling */
        .table td {
            padding: 0.75rem 0;
            border: none;
            vertical-align: middle;
        }

            .table td:first-child {
                width: 40%;
                color: #6c757d;
                font-weight: 500;
            }

        /* Card improvements */
        .card {
            border: none;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border-radius: 10px;
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
            border-radius: 10px 10px 0 0 !important;
        }

        /* Button improvements */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,123,255,0.3);
            }

        /* Responsive adjustments */
        @@media (max-width: 992px) {
            .fullscreen-carousel, .car-detail-image

        {
            height: 40vh;
            min-height: 300px;
        }

        .fullscreen-header h5 {
            font-size: 1rem;
        }

        }

        @@media (max-width: 768px) {
            .fullscreen-carousel, .car-detail-image

        {
            height: 30vh;
            min-height: 250px;
        }

        .carousel-thumb {
            height: 40px;
        }

        .nav-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
        }

            .nav-tabs .nav-link {
                white-space: nowrap;
            }

        }

        /* Print styles */
        @@media print {
            .fullscreen-header, .btn, .modal, .carousel-control-prev, .carousel-control-next, .carousel-indicators

        {
            display: none !important;
        }

        body {
            margin: 0;
        }

        .container-fluid {
            margin-top: 0 !important;
        }

        }

        /* Force visibility */
        #mainContent {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        #loadingSpinner.d-none,
        #loadingSpinner[style*="display: none"] {
            display: none !important;
        }

        /* Smooth animations */
        .carousel-item {
            transition: transform 0.6s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @@keyframes fadeIn {
            from

        {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        /* Badge improvements */
        .badge {
            font-size: 0.75em;
            padding: 0.5em 0.75em;
            border-radius: 20px;
        }

        /* Improve similar cars section */
        .car-card-small {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

            .car-card-small:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
    </style>
</body>
</html>