<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Details - Used Car Dealer</title>
    <meta name="description" content="View detailed specifications, images, and seller information for this used car. Schedule a test drive or make an inquiry today.">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-car me-2"></i>
                Used Car Dealer
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/cars">Browse Cars</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin">Admin Panel</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5">
        <div class="container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading car details...</p>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" style="display: none;">
        <!-- Breadcrumb -->
        <section class="bg-light py-3">
            <div class="container">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/cars">Browse Cars</a></li>
                        <li class="breadcrumb-item active" id="breadcrumbTitle">Car Details</li>
                    </ol>
                </nav>
            </div>
        </section>

        <div class="container py-4">
            <div class="row">
                <!-- Car Images -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-body p-0">
                            <!-- Main Image -->
                            <div id="carImageCarousel" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner" id="carouselImages">
                                    <div class="carousel-item active">
                                        <img src="" class="d-block w-100" alt="Car Image" style="height: 400px; object-fit: cover;" id="mainCarImage">
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carImageCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carImageCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                            </div>

                            <!-- Thumbnail Images -->
                            <div class="p-3">
                                <div class="row g-2" id="thumbnailContainer">
                                    <!-- Thumbnails will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Car Description -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Description</h5>
                        </div>
                        <div class="card-body">
                            <p id="carDescription" class="mb-0">Loading description...</p>
                        </div>
                    </div>

                    <!-- Specifications -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Specifications</h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="specificationsContainer">
                                <!-- Specifications will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-star me-2"></i>Features</h5>
                        </div>
                        <div class="card-body">
                            <div id="featuresContainer">
                                <!-- Features will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Car Info Sidebar -->
                <div class="col-lg-4">
                    <!-- Car Title & Price -->
                    <div class="card">
                        <div class="card-body">
                            <h1 class="h3 mb-2" id="carTitle">Loading...</h1>
                            <div class="car-price mb-3" id="carPrice">₹0</div>

                            <!-- Key Info -->
                            <div class="row g-2 mb-3" id="keyInfoContainer">
                                <!-- Key info badges will be loaded here -->
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <a href="#" class="btn btn-primary btn-lg" id="inquireBtn">
                                    <i class="fas fa-envelope me-2"></i>Make Inquiry
                                </a>
                                <button class="btn btn-outline-primary" id="callBtn">
                                    <i class="fas fa-phone me-2"></i>Call Seller
                                </button>
                                <button class="btn btn-outline-secondary" id="shareBtn">
                                    <i class="fas fa-share me-2"></i>Share This Car
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Seller Information -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Seller Information</h5>
                        </div>
                        <div class="card-body">
                            <div id="sellerInfo">
                                <!-- Seller info will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Car Condition -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Vehicle Condition</h5>
                        </div>
                        <div class="card-body">
                            <div id="conditionInfo">
                                <!-- Condition info will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- EMI Calculator -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>EMI Calculator</h5>
                        </div>
                        <div class="card-body">
                            <form id="emiCalculator">
                                <div class="mb-3">
                                    <label for="loanAmount" class="form-label">Loan Amount</label>
                                    <input type="number" class="form-control" id="loanAmount" placeholder="Enter amount">
                                </div>
                                <div class="mb-3">
                                    <label for="interestRate" class="form-label">Interest Rate (%)</label>
                                    <input type="number" class="form-control" id="interestRate" value="8.5" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label for="loanTenure" class="form-label">Tenure (Years)</label>
                                    <select class="form-select" id="loanTenure">
                                        <option value="1">1 Year</option>
                                        <option value="2">2 Years</option>
                                        <option value="3" selected>3 Years</option>
                                        <option value="4">4 Years</option>
                                        <option value="5">5 Years</option>
                                        <option value="7">7 Years</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-outline-primary w-100" onclick="calculateEMI()">
                                    Calculate EMI
                                </button>
                                <div id="emiResult" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Monthly EMI: </strong><span id="emiAmount">₹0</span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Used Car Dealer</h5>
                    <p class="text-muted">Your trusted partner for quality pre-owned vehicles.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-muted">&copy; 2025 Used Car Dealer Platform. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Call Modal -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contact Seller</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="contactInfo">
                        <!-- Contact information will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share This Car</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="shareUrl" class="form-label">Share URL</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="shareUrl" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard()">Copy</button>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="shareOnWhatsApp()">
                            <i class="fab fa-whatsapp me-2"></i>Share on WhatsApp
                        </button>
                        <button class="btn btn-primary" onclick="shareOnFacebook()">
                            <i class="fab fa-facebook me-2"></i>Share on Facebook
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div class="alert-container position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script src="/js/main.js"></script>

    <!-- Car details specific JavaScript -->
    <script>
        let currentCar = null;
        let listingId = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Get listing ID from URL
            const pathParts = window.location.pathname.split('/');
            listingId = pathParts[pathParts.length - 1];

            if (listingId && !isNaN(listingId)) {
                loadCarDetails(listingId);
            } else {
                showError('Invalid car listing ID');
            }
        });

        // Load car details
        async function loadCarDetails(id) {
            try {
                const listing = await ApiService.getListing(id);
                currentCar = listing;

                // Record page view
                ApiService.recordView(id).catch(console.error);

                // Render car details
                renderCarDetails(listing);

                // Show main content and hide loading
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('Failed to load car details:', error);
                showError('Failed to load car details');
            }
        }

        // Render car details
        function renderCarDetails(car) {
            // Update page title and breadcrumb
            document.title = `${car.listingTitle} - Used Car Dealer`;
            document.getElementById('breadcrumbTitle').textContent = car.listingTitle;

            // Update car info
            document.getElementById('carTitle').textContent = car.listingTitle;
            document.getElementById('carPrice').textContent = Utils.formatCurrency(car.sellingPriceAsked);
            document.getElementById('carDescription').textContent = car.detailedDescription || 'No description available.';

            // Update inquiry button
            document.getElementById('inquireBtn').href = `/inquiry/${car.listingId}`;

            // Render key info badges
            renderKeyInfo(car);

            // Render specifications
            renderSpecifications(car);

            // Render features (placeholder for now)
            renderFeatures(car);

            // Render seller info
            renderSellerInfo(car);

            // Render condition info
            renderConditionInfo(car);

            // Setup images
            setupImages(car);

            // Setup EMI calculator
            setupEMICalculator(car);

            // Setup modals
            setupModals(car);
        }

        // Render key info badges
        function renderKeyInfo(car) {
            const container = document.getElementById('keyInfoContainer');
            const keyInfo = [
                { label: 'Year', value: car.manufacturingYear, icon: 'calendar' },
                { label: 'Fuel', value: car.fuelTypeName, icon: 'gas-pump' },
                { label: 'Transmission', value: car.transmissionName, icon: 'cogs' },
                { label: 'KM Driven', value: Utils.formatNumber(car.kilometersOnOdometer), icon: 'road' },
                { label: 'Owners', value: car.totalPreviousOwners, icon: 'user' },
                { label: 'Location', value: `${car.cityName}, ${car.stateName}`, icon: 'map-marker-alt' }
            ];

            container.innerHTML = keyInfo.map(info => `
                <div class="col-6">
                    <div class="text-center p-2 bg-light rounded">
                        <i class="fas fa-${info.icon} text-primary mb-1"></i>
                        <div class="small text-muted">${info.label}</div>
                        <div class="fw-bold">${info.value}</div>
                    </div>
                </div>
            `).join('');
        }

        // Render specifications
        function renderSpecifications(car) {
            const container = document.getElementById('specificationsContainer');
            const specs = [
                { label: 'Engine Capacity', value: car.engineCapacityInCC ? `${car.engineCapacityInCC} CC` : 'N/A' },
                { label: 'Power', value: car.enginePowerInBHP ? `${car.enginePowerInBHP} BHP` : 'N/A' },
                { label: 'Torque', value: car.engineTorqueInNm ? `${car.engineTorqueInNm} Nm` : 'N/A' },
                { label: 'Seating Capacity', value: car.seatingCapacity ? `${car.seatingCapacity} Seats` : 'N/A' },
                { label: 'Doors', value: car.numberOfDoors ? `${car.numberOfDoors} Doors` : 'N/A' },
                { label: 'Color', value: car.colorName || 'N/A' },
                { label: 'Registration', value: car.registrationNumber || 'N/A' },
                { label: 'Mileage (City)', value: car.mileageInCityKMPL ? `${car.mileageInCityKMPL} KMPL` : 'N/A' },
                { label: 'Mileage (Highway)', value: car.mileageOnHighwayKMPL ? `${car.mileageOnHighwayKMPL} KMPL` : 'N/A' },
                { label: 'Condition', value: car.conditionName || 'N/A' }
            ];

            container.innerHTML = specs.map(spec => `
                <div class="col-md-6 mb-2">
                    <strong>${spec.label}:</strong> ${spec.value}
                </div>
            `).join('');
        }

        // Render features (placeholder)
        function renderFeatures(car) {
            const container = document.getElementById('featuresContainer');
            // This would normally load from the CarListingFeatures table
            const sampleFeatures = [
                'Air Conditioning', 'Power Steering', 'Power Windows', 'Central Locking',
                'ABS', 'Airbags', 'Alloy Wheels', 'Music System'
            ];

            container.innerHTML = `
                <div class="row">
                    ${sampleFeatures.map(feature => `
                        <div class="col-md-6 mb-2">
                            <i class="fas fa-check text-success me-2"></i>${feature}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render seller info
        function renderSellerInfo(car) {
            const container = document.getElementById('sellerInfo');
            container.innerHTML = `
                <div class="mb-3">
                    <h6 class="fw-bold">${car.sellerName}</h6>
                    <div class="text-muted small">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        ${car.areaOrLocality ? car.areaOrLocality + ', ' : ''}${car.cityName}, ${car.stateName}
                    </div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Contact Available for:</small>
                </div>
                <div class="mb-3">
                    <span class="badge bg-success me-1">Phone Calls</span>
                    ${car.sellerWhatsAppNumber ? '<span class="badge bg-success me-1">WhatsApp</span>' : ''}
                    ${car.sellerEmailAddress ? '<span class="badge bg-success me-1">Email</span>' : ''}
                </div>
                <div class="text-center">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Usually responds within 2 hours
                    </small>
                </div>
            `;
        }

        // Render condition info
        function renderConditionInfo(car) {
            const container = document.getElementById('conditionInfo');

            const ratings = [
                { label: 'Exterior', value: car.exteriorConditionRating || 0 },
                { label: 'Interior', value: car.interiorConditionRating || 0 },
                { label: 'Engine', value: car.engineConditionRating || 0 },
                { label: 'Tyres', value: car.tyreConditionRating || 0 }
            ];

            container.innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Overall Condition</span>
                        <span class="badge bg-success">${car.conditionName || 'Good'}</span>
                    </div>
                </div>
                ${ratings.map(rating => `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">${rating.label}</span>
                            <span class="small fw-bold">${rating.value}/10</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar ${getProgressBarClass(rating.value)}"
                                 style="width: ${rating.value * 10}%"></div>
                        </div>
                    </div>
                `).join('')}
                <div class="mt-3">
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="text-center">
                                <i class="fas fa-${car.hasAccidentHistory ? 'exclamation-triangle text-warning' : 'check-circle text-success'} mb-1"></i>
                                <div class="small">${car.hasAccidentHistory ? 'Accident History' : 'No Accidents'}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <i class="fas fa-${car.hasCompleteServiceHistory ? 'check-circle text-success' : 'times-circle text-muted'} mb-1"></i>
                                <div class="small">${car.hasCompleteServiceHistory ? 'Full Service History' : 'Partial History'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Setup images (placeholder implementation)
        function setupImages(car) {
            const mainImage = document.getElementById('mainCarImage');
            const placeholderImage = Utils.getPlaceholderImage(800, 400, 'Car Image');

            mainImage.src = car.imageUrl || placeholderImage;
            mainImage.onerror = function() {
                this.src = placeholderImage;
            };

            // Setup thumbnails (placeholder)
            const thumbnailContainer = document.getElementById('thumbnailContainer');
            thumbnailContainer.innerHTML = `
                <div class="col-3">
                    <img src="${placeholderImage}" class="img-fluid rounded cursor-pointer"
                         onclick="changeMainImage(this.src)" alt="Car Image 1">
                </div>
                <div class="col-3">
                    <img src="${placeholderImage}" class="img-fluid rounded cursor-pointer"
                         onclick="changeMainImage(this.src)" alt="Car Image 2">
                </div>
                <div class="col-3">
                    <img src="${placeholderImage}" class="img-fluid rounded cursor-pointer"
                         onclick="changeMainImage(this.src)" alt="Car Image 3">
                </div>
                <div class="col-3">
                    <img src="${placeholderImage}" class="img-fluid rounded cursor-pointer"
                         onclick="changeMainImage(this.src)" alt="Car Image 4">
                </div>
            `;
        }

        // Setup EMI calculator
        function setupEMICalculator(car) {
            document.getElementById('loanAmount').value = car.sellingPriceAsked * 0.8; // 80% of car price
        }

        // Setup modals
        function setupModals(car) {
            // Setup call modal
            document.getElementById('callBtn').onclick = function() {
                document.getElementById('contactInfo').innerHTML = `
                    <div class="text-center">
                        <h5 class="mb-3">${car.sellerName}</h5>
                        <div class="mb-3">
                            <a href="tel:${car.sellerPrimaryPhone}" class="btn btn-primary btn-lg">
                                <i class="fas fa-phone me-2"></i>${car.sellerPrimaryPhone}
                            </a>
                        </div>
                        ${car.sellerWhatsAppNumber ? `
                            <div class="mb-3">
                                <a href="https://wa.me/${car.sellerWhatsAppNumber.replace(/[^0-9]/g, '')}"
                                   class="btn btn-success" target="_blank">
                                    <i class="fab fa-whatsapp me-2"></i>WhatsApp
                                </a>
                            </div>
                        ` : ''}
                        <div class="text-muted small">
                            Best time to call: ${car.availableForContactHours || 'Anytime during business hours'}
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('callModal')).show();
            };

            // Setup share modal
            document.getElementById('shareBtn').onclick = function() {
                document.getElementById('shareUrl').value = window.location.href;
                new bootstrap.Modal(document.getElementById('shareModal')).show();
            };
        }

        // Helper functions
        function getProgressBarClass(rating) {
            if (rating >= 8) return 'bg-success';
            if (rating >= 6) return 'bg-warning';
            return 'bg-danger';
        }

        function changeMainImage(src) {
            document.getElementById('mainCarImage').src = src;
        }

        function calculateEMI() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const tenure = parseFloat(document.getElementById('loanTenure').value);

            if (!loanAmount || !interestRate || !tenure) {
                Utils.showAlert('Please fill all EMI calculator fields', 'warning');
                return;
            }

            const monthlyRate = interestRate / 12 / 100;
            const totalMonths = tenure * 12;

            const emi = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) /
                        (Math.pow(1 + monthlyRate, totalMonths) - 1);

            document.getElementById('emiAmount').textContent = Utils.formatCurrency(Math.round(emi));
            document.getElementById('emiResult').style.display = 'block';
        }

        function copyToClipboard() {
            const shareUrl = document.getElementById('shareUrl');
            shareUrl.select();
            document.execCommand('copy');
            Utils.showAlert('URL copied to clipboard!', 'success');
        }

        function shareOnWhatsApp() {
            const text = `Check out this ${currentCar.listingTitle} for ${Utils.formatCurrency(currentCar.sellingPriceAsked)}`;
            const url = encodeURIComponent(window.location.href);
            window.open(`https://wa.me/?text=${encodeURIComponent(text)} ${url}`, '_blank');
        }

        function shareOnFacebook() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
        }
        Zzzzzzzzzzzzzzzzzzzzz
        function showError(message) {
            document.getElementById('loadingState').innerHTML = `
                <div class="container">
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <h4>Error</h4>
                        <p class="text-muted">${message}</p>
                        <a href="/cars" class="btn btn-primary">Browse Other Cars</a>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>